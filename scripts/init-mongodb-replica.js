// –°–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ MongoDB —Ä–µ–ø–ª–∏–∫–∏
// –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ mongodb-setup

print('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MongoDB —Ä–µ–ø–ª–∏–∫–∏...');

// –ñ–¥–µ–º, –ø–æ–∫–∞ –≤—Å–µ —É–∑–ª—ã –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã
sleep(5000);

try {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–ø–ª–∏–∫—É
  var config = {
    _id: "rs0",
    members: [
      { _id: 0, host: "mongodb-primary:27017", priority: 2 },
      { _id: 1, host: "mongodb-secondary:27017", priority: 1 },
      { _id: 2, host: "mongodb-arbiter:27017", arbiterOnly: true }
    ]
  };

  print('üìù –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ–ø–ª–∏–∫–∏:');
  printjson(config);

  var result = rs.initiate(config);
  print('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:');
  printjson(result);

  // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  print('‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...');
  sleep(10000);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
  var status = rs.status();
  print('üìä –°—Ç–∞—Ç—É—Å —Ä–µ–ø–ª–∏–∫–∏:');
  printjson(status);

  // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
  print('üë§ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
  
  db = db.getSiblingDB('app_database');
  
  try {
    db.createUser({
      user: "app_user",
      pwd: "app_password",
      roles: [
        { role: "readWrite", db: "app_database" }
      ]
    });
    print('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å app_user —Å–æ–∑–¥–∞–Ω');
  } catch (e) {
    if (e.code === 51003) {
      print('‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å app_user —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
    } else {
      print('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
    }
  }

  print('üéâ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MongoDB —Ä–µ–ø–ª–∏–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');

} catch (error) {
  print('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–ø–ª–∏–∫–∏:', error);
  quit(1);
}