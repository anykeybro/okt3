# ะะฐัััะพะนะบะฐ MongoDB ะะตะฟะปะธะบะธ

## ะะฑะทะพั

ะ ะฟัะพะตะบัะต ะฝะฐัััะพะตะฝะฐ MongoDB ัะตะฟะปะธะบะฐ ะธะท 3 ัะทะปะพะฒ ะดะปั ะพะฑะตัะฟะตัะตะฝะธั ะฒััะพะบะพะน ะดะพัััะฟะฝะพััะธ ะธ ะพัะบะฐะทะพัััะพะนัะธะฒะพััะธ:

- **mongodb-primary** - ะพัะฝะพะฒะฝะพะน ัะทะตะป (ะฟะพัั 27017)
- **mongodb-secondary** - ะฒัะพัะธัะฝัะน ัะทะตะป (ะฟะพัั 27018) 
- **mongodb-arbiter** - ะฐัะฑะธัั (ะฟะพัั 27019)

## ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ  MongoDB        โ    โ  MongoDB        โ    โ  MongoDB        โ
โ  Primary        โโโโโบโ  Secondary      โ    โ  Arbiter        โ
โ  :27017         โ    โ  :27018         โ    โ  :27019         โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
         โฒ                       โฒ                       โฒ
         โ                       โ                       โ
         โโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโ
                                 โ
                    โโโโโโโโโโโโโโโโโโโ
                    โ   App Server    โ
                    โ   (Prisma)      โ
                    โโโโโโโโโโโโโโโโโโโ
```

## ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

### Development (.env.development)
```bash
MONGODB_REPLICA_SET_NAME=rs0
MONGODB_ROOT_USERNAME=admin
MONGODB_ROOT_PASSWORD=mongodb_admin_pwd
MONGODB_DATABASE=app_database
DATABASE_URL=mongodb://admin:mongodb_admin_pwd@mongodb-primary:27017,mongodb-secondary:27017,mongodb-arbiter:27017/app_database?replicaSet=rs0&authSource=admin
```

### Production (.env.production)
```bash
MONGODB_REPLICA_SET_NAME=rs0
MONGODB_ROOT_USERNAME=admin
MONGODB_ROOT_PASSWORD=CHANGE_ME_SECURE_MONGODB_PASSWORD
MONGODB_DATABASE=app_database
DATABASE_URL=mongodb://admin:SECURE_PASSWORD@mongodb-primary:27017,mongodb-secondary:27017,mongodb-arbiter:27017/app_database?replicaSet=rs0&authSource=admin
```

## ะะตะทะพะฟะฐัะฝะพััั

### ะะปัั ัะตะฟะปะธะบะธ
ะะปั ะฐััะตะฝัะธัะธะบะฐัะธะธ ะผะตะถะดั ัะทะปะฐะผะธ ัะตะฟะปะธะบะธ ะธัะฟะพะปัะทัะตััั ะพะฑัะธะน ะบะปัั `mongodb-keyfile`:
- ะะตะฝะตัะธััะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟัะธ ะฟะตัะฒะพะผ ะทะฐะฟััะบะต
- ะะพะปะถะตะฝ ะฑััั ะพะดะธะฝะฐะบะพะฒัะผ ะฝะฐ ะฒัะตั ัะทะปะฐั
- ะัะฐะฒะฐ ะดะพัััะฟะฐ ะพะณัะฐะฝะธัะตะฝั ัะพะปัะบะพ ะดะปั ะฒะปะฐะดะตะปััะฐ

### ะััะตะฝัะธัะธะบะฐัะธั
- ะะบะปััะตะฝะฐ ะฐััะตะฝัะธัะธะบะฐัะธั ั ะฟะพะปัะทะพะฒะฐัะตะปะตะผ root
- ะัะต ะฟะพะดะบะปััะตะฝะธั ััะตะฑััั ะฐะฒัะพัะธะทะฐัะธะธ
- App-server ะฟะพะดะบะปััะฐะตััั ั ะฟัะฐะฒะฐะผะธ ะฐะดะผะธะฝะธัััะฐัะพัะฐ

## ะะฐะฟััะบ

### Development
```bash
# ะะพะฟะธััะตะผ ะฟัะธะผะตั ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
copy .env.development.example .env.development

# ะะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั
docker-compose -f docker-compose.dev.yml up -d

# ะัะพะฒะตััะตะผ ััะฐััั ัะตะฟะปะธะบะธ
docker exec mongodb-primary-dev mongosh --eval "rs.status()"
```

### Production
```bash
# ะะพะฟะธััะตะผ ะธ ะฝะฐัััะฐะธะฒะฐะตะผ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
copy .env.production.example .env.production
# ะะทะผะตะฝะธัะต ะฟะฐัะพะปะธ ะฒ .env.production!

# ะะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั
docker-compose -f docker-compose.production.yml up -d

# ะัะพะฒะตััะตะผ ััะฐััั ัะตะฟะปะธะบะธ
docker exec mongodb-primary-prod mongosh --eval "rs.status()"
```

## ะะพะฝะธัะพัะธะฝะณ

### ะัะพะฒะตัะบะฐ ััะฐัััะฐ ัะตะฟะปะธะบะธ
```bash
# ะะพะดะบะปััะตะฝะธะต ะบ primary ัะทะปั
docker exec -it mongodb-primary-dev mongosh -u admin -p mongodb_admin_pwd

# ะะพะผะฐะฝะดั ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ
rs.status()           # ะกัะฐััั ัะตะฟะปะธะบะธ
rs.isMaster()         # ะะฝัะพัะผะฐัะธั ะพ ะผะฐััะตัะต
db.stats()            # ะกัะฐัะธััะธะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั
```

### ะะพะณะธ
```bash
# ะะพะณะธ primary ัะทะปะฐ
docker logs mongodb-primary-dev

# ะะพะณะธ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ัะตะฟะปะธะบะธ
docker logs mongodb-setup-dev

# ะะพะณะธ app-server (ะฟะพะดะบะปััะตะฝะธะต ะบ ะะ)
docker logs app-server-container
```

## ะะพะดะบะปััะตะฝะธะต App Server

App Server ะธัะฟะพะปัะทัะตั Prisma ะดะปั ะฟะพะดะบะปััะตะฝะธั ะบ MongoDB:

### ะกัะตะผะฐ Prisma
```prisma
datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}
```

### ะะพะณะธัะพะฒะฐะฝะธะต ะฟะพะดะบะปััะตะฝะธั
ะัะธ ััะฟะตัะฝะพะผ ะฟะพะดะบะปััะตะฝะธะธ ะฒ ะปะพะณะฐั app-server ะฟะพัะฒัััั ัะพะพะฑัะตะฝะธั:
```
โ ะะพะดะบะปััะตะฝะธะต ะบ MongoDB ัะตะฟะปะธะบะต ััะฟะตัะฝะพ ัััะฐะฝะพะฒะปะตะฝะพ
๐ ะะฐะทะฐ ะดะฐะฝะฝัั: app_database
๐ ะะตะฟะปะธะบะฐ ัะตั: rs0
๐ ะกัะฐััั ัะตะฟะปะธะบะธ: { ismaster: true, ... }
```

## ะะตะทะตัะฒะฝะพะต ะบะพะฟะธัะพะฒะฐะฝะธะต

### ะะฒัะพะผะฐัะธัะตัะบะพะต ัะตะทะตัะฒะฝะพะต ะบะพะฟะธัะพะฒะฐะฝะธะต (Production)
```bash
# ะกะพะทะดะฐะฝะธะต ะฑัะบะฐะฟะฐ
docker exec mongodb-primary-prod mongodump --uri="mongodb://admin:PASSWORD@localhost:27017/app_database?authSource=admin" --out /backups/$(date +%Y%m%d_%H%M%S)

# ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะธะท ะฑัะบะฐะฟะฐ
docker exec mongodb-primary-prod mongorestore --uri="mongodb://admin:PASSWORD@localhost:27017/app_database?authSource=admin" /backups/BACKUP_FOLDER
```

## ะฃัััะฐะฝะตะฝะธะต ะฝะตะฟะพะปะฐะดะพะบ

### ะะตะฟะปะธะบะฐ ะฝะต ะธะฝะธัะธะฐะปะธะทะธััะตััั
1. ะัะพะฒะตัััะต, ััะพ ะฒัะต ัะทะปั ะทะฐะฟััะตะฝั: `docker ps`
2. ะัะพะฒะตัััะต ะปะพะณะธ setup ะบะพะฝัะตะนะฝะตัะฐ: `docker logs mongodb-setup-dev`
3. ะฃะฑะตะดะธัะตัั, ััะพ ะบะปัั mongodb-keyfile ะดะพัััะฟะตะฝ ะฒัะตะผ ะบะพะฝัะตะนะฝะตัะฐะผ

### App Server ะฝะต ะผะพะถะตั ะฟะพะดะบะปััะธัััั
1. ะัะพะฒะตัััะต ะฟะตัะตะผะตะฝะฝัั DATABASE_URL ะฒ .env ัะฐะนะปะต
2. ะฃะฑะตะดะธัะตัั, ััะพ ัะตะฟะปะธะบะฐ ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝะฐ: `rs.status()`
3. ะัะพะฒะตัััะต ะปะพะณะธ app-server ะฝะฐ ะพัะธะฑะบะธ ะฟะพะดะบะปััะตะฝะธั

### ะัะพะฑะปะตะผั ั ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพัััั
1. ะะพะฝะธัะพัััะต ััะฐััั ัะตะฟะปะธะบะธ: `rs.status()`
2. ะัะพะฒะตัััะต ะฝะฐะณััะทะบั ะฝะฐ ัะทะปั: `db.serverStatus()`
3. ะะฐััะผะพััะธัะต ะดะพะฑะฐะฒะปะตะฝะธะต ะธะฝะดะตะบัะพะฒ ะดะปั ัะฐััะพ ะธัะฟะพะปัะทัะตะผัั ะทะฐะฟัะพัะพะฒ

## ะะฐัััะฐะฑะธัะพะฒะฐะฝะธะต

ะะปั ะดะพะฑะฐะฒะปะตะฝะธั ะฝะพะฒัั ัะทะปะพะฒ ะฒ ัะตะฟะปะธะบั:
1. ะะพะฑะฐะฒััะต ะฝะพะฒัะน ัะตัะฒะธั ะฒ docker-compose
2. ะะฑะฝะพะฒะธัะต ะบะพะฝัะธะณััะฐัะธั ัะตะฟะปะธะบะธ ัะตัะตะท `rs.add()`
3. ะะฑะฝะพะฒะธัะต ัััะพะบั ะฟะพะดะบะปััะตะฝะธั DATABASE_URL