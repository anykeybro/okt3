# Биллинговый движок OK-Telecom

## Обзор

Биллинговый движок - это автоматизированная система для управления списанием средств с лицевых счетов абонентов, блокировкой неплательщиков и отправкой уведомлений.

## Основные компоненты

### 1. BillingEngine
Основной класс для обработки биллинга. Выполняет:
- Автоматическое списание средств согласно тарифному плану
- Проверку балансов и блокировку при недостатке средств
- Отправку уведомлений о низком балансе
- Разблокировку при пополнении баланса

### 2. BillingScheduler
Планировщик для автоматического запуска биллинга по расписанию:
- Запуск каждый час через cron
- Сохранение статистики выполнения
- Логирование ошибок
- Мониторинг состояния

### 3. BillingService
Сервисный слой для работы с биллингом:
- Управление планировщиком
- Получение статистики
- Обработка пополнений баланса
- Проверка аккаунтов с низким балансом

### 4. BillingController
REST API контроллер для управления биллингом через веб-интерфейс.

## Типы тарификации

### Предоплатная (PREPAID_MONTHLY)
- Списание происходит раз в месяц
- Сумма списания равна стоимости тарифного плана
- Первое списание происходит сразу при подключении
- Следующие списания - через месяц после предыдущего

### Почасовая (HOURLY)
- Списание происходит каждый час
- Сумма рассчитывается как: `(цена_тарифа / 30 / 24) * количество_часов`
- Минимальный интервал списания - 1 час

## Логика блокировки

1. **Проверка баланса**: Если баланс <= `blockThreshold`, аккаунт блокируется
2. **Автоблокировка**: Включается через конфигурацию `autoBlockEnabled`
3. **Разблокировка**: Автоматически при пополнении баланса выше порога

## Уведомления

Система отправляет уведомления при достижении пороговых значений баланса:
- По умолчанию: 100, 50, 10 рублей
- Приоритет каналов: Telegram → SMS
- Создаются записи в таблице `notifications`

## API Endpoints

### GET /api/billing/stats
Получение статистики биллинга за указанный период.

**Параметры:**
- `days` (optional) - количество дней для анализа (по умолчанию 30)

**Ответ:**
```json
{
  "success": true,
  "data": {
    "totalCharges": 150,
    "totalAmount": 75000,
    "blockedAccounts": 5,
    "averageBalance": 250.50,
    "recentActivity": [...]
  }
}
```

### POST /api/billing/run
Ручной запуск биллинга (требует права администратора).

**Ответ:**
```json
{
  "success": true,
  "message": "Биллинг выполнен успешно",
  "data": {
    "totalProcessed": 100,
    "successfulCharges": 95,
    "failedCharges": 5,
    "blockedAccounts": 2,
    "notificationsSent": 10,
    "totalAmount": 47500
  }
}
```

### POST /api/billing/test
Тестовый запуск биллинга без изменений в БД.

### GET /api/billing/next-charge/:accountId
Получение информации о следующем списании для аккаунта.

**Ответ:**
```json
{
  "success": true,
  "data": {
    "nextChargeDate": "2024-02-15T10:00:00Z",
    "nextChargeAmount": 500,
    "daysUntilCharge": 5
  }
}
```

### GET /api/billing/low-balance
Получение списка аккаунтов с низким балансом.

### GET /api/billing/scheduler/status
Получение статуса планировщика.

### POST /api/billing/scheduler/start
Запуск планировщика.

### POST /api/billing/scheduler/stop
Остановка планировщика.

### GET /api/billing/errors
Получение истории ошибок биллинга.

## Конфигурация

Настройки биллинга в `config.ts`:

```typescript
billing: {
  hourlyCheckInterval: 3600000, // 1 час в миллисекундах
  notificationThresholds: [100, 50, 10], // Пороги уведомлений в рублях
  autoBlockEnabled: true, // Автоматическая блокировка
  defaultBlockThreshold: 0, // Порог блокировки по умолчанию
}
```

## Переменные окружения

```bash
# Интервал проверки биллинга (мс)
BILLING_CHECK_INTERVAL=3600000

# Автоматическая блокировка
BILLING_AUTO_BLOCK=true

# Порог блокировки по умолчанию
DEFAULT_BLOCK_THRESHOLD=0
```

## Мониторинг

### Статистика выполнения
Система сохраняет статистику каждого запуска в коллекцию `billing_stats`:
- Время выполнения
- Количество обработанных аккаунтов
- Суммы списаний
- Количество блокировок и уведомлений

### Логирование ошибок
Ошибки сохраняются в коллекцию `billing_errors`:
- Время возникновения
- Текст ошибки
- Stack trace

### Метрики для мониторинга
- Время выполнения биллингового цикла
- Количество ошибок
- Количество заблокированных аккаунтов
- Средний баланс абонентов

## Интеграция с другими модулями

### Платежная система
При поступлении платежа вызывается `handleBalanceTopUp()` для проверки возможности разблокировки аккаунта.

### Система уведомлений
Создаются записи в таблице `notifications`, которые обрабатываются модулем уведомлений.

### MikroTik устройства
При блокировке/разблокировке отправляются команды через Kafka для управления доступом на сетевом уровне.

## Безопасность

1. **Транзакции**: Все операции списания выполняются в транзакциях
2. **Валидация**: Проверка достаточности средств перед списанием
3. **Аудит**: Все операции логируются
4. **Права доступа**: Административные функции требуют соответствующих прав

## Тестирование

### Unit тесты
- Тестирование логики расчета списаний
- Проверка условий блокировки/разблокировки
- Валидация уведомлений

### Тестовый режим
Режим `dryRun` позволяет запустить биллинг без реальных изменений в БД для тестирования логики.

## Производительность

### Оптимизации
- Пакетная обработка аккаунтов
- Индексы на часто используемые поля
- Ограничение размера коллекций статистики

### Масштабирование
- Возможность запуска на нескольких инстансах
- Блокировки для предотвращения дублирования
- Мониторинг производительности

## Восстановление после сбоев

1. **Идемпотентность**: Повторный запуск не создает дублирующих списаний
2. **Откат транзакций**: При ошибке изменения откатываются
3. **Логирование**: Детальные логи для анализа проблем
4. **Уведомления**: Алерты при критических ошибках

## Примеры использования

### Ручной запуск биллинга
```bash
curl -X POST http://localhost:3001/api/billing/run \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Проверка статуса планировщика
```bash
curl http://localhost:3001/api/billing/scheduler/status \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Получение аккаунтов с низким балансом
```bash
curl http://localhost:3001/api/billing/low-balance \
  -H "Authorization: Bearer YOUR_TOKEN"
```