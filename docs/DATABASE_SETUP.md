# Настройка базы данных для биллинг-системы OK-Telecom

## Обзор

Биллинг-система использует MongoDB в качестве основной базы данных с Prisma ORM для работы с данными.

## Структура базы данных

### Основные коллекции

1. **system_users** - Администраторы системы
2. **roles** - Роли и права доступа
3. **permissions** - Детальные права доступа
4. **clients** - Абоненты
5. **accounts** - Лицевые счета
6. **services** - Услуги (Интернет, IPTV, Облако)
7. **tariffs** - Тарифные планы
8. **tariff_groups** - Группы тарифов
9. **devices** - Сетевые устройства MikroTik
10. **requests** - Заявки от клиентов
11. **payments** - Платежи и транзакции
12. **notifications** - Уведомления
13. **notification_templates** - Шаблоны уведомлений

## Инициализация базы данных

### 1. Генерация Prisma клиента

```bash
yarn workspace app-server db:generate
```

### 2. Применение схемы к базе данных

```bash
yarn workspace app-server db:push
```

### 3. Заполнение начальными данными

```bash
yarn workspace app-server db:seed
```

## Начальные данные

### Роли системы

1. **Суперадмин** - Полный доступ ко всем функциям
2. **Кассир** - Доступ к платежам и клиентам
3. **Монтажник** - Доступ к заявкам и техническим операциям

### Базовые услуги

1. **Интернет** - Доступ к сети Интернет
2. **IPTV** - Интерактивное телевидение
3. **Облачное хранилище** - Персональное облачное хранилище

### Тарифные планы

1. **Базовый** - 500₽/мес, 50/10 Мбит/с, только Интернет
2. **Стандарт** - 800₽/мес, 100/20 Мбит/с, Интернет + IPTV
3. **Премиум** - 1200₽/мес, 200/50 Мбит/с, все услуги

### Шаблоны уведомлений

Создаются шаблоны для всех типов уведомлений:
- Приветствие
- Платежи
- Низкий баланс
- Блокировка/разблокировка

## Переменные окружения

Убедитесь, что настроены следующие переменные:

```bash
# MongoDB
DATABASE_URL=mongodb://admin:password@localhost:27017,localhost:27018,localhost:27019/app_database?replicaSet=rs0&authSource=admin
DB_MAX_POOL_SIZE=10
DB_TIMEOUT=5000
```

## Мониторинг

Для мониторинга состояния базы данных используйте:

```bash
# Prisma Studio
yarn workspace app-server db:studio

# Health check API
curl http://localhost:3001/health
```

## Резервное копирование

Рекомендуется настроить автоматическое резервное копирование MongoDB:

```bash
# Создание бэкапа
mongodump --uri="mongodb://admin:password@localhost:27017/app_database?authSource=admin" --out=/backup/$(date +%Y%m%d)

# Восстановление
mongorestore --uri="mongodb://admin:password@localhost:27017/app_database?authSource=admin" /backup/20240101
```

## Индексы

Prisma автоматически создает индексы на основе схемы. Дополнительные индексы для производительности будут добавлены в следующих версиях.

## Миграции

При изменении схемы используйте:

```bash
# Применить изменения к базе данных
yarn workspace app-server db:push

# Регенерировать клиент
yarn workspace app-server db:generate
```