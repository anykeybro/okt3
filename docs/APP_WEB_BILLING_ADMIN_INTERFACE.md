# Административный веб-интерфейс (app-web-billing)

## Обзор

Административный веб-интерфейс биллинг-системы OK-Telecom построен на базе Next.js 15 с TypeScript и Material-UI. Предоставляет полнофункциональную панель управления для администраторов, кассиров и технических специалистов.

## Архитектура

### Технологический стек

- **Frontend Framework**: Next.js 15 (App Router)
- **Language**: TypeScript
- **UI Library**: Material-UI (MUI) v5
- **State Management**: TanStack Query (React Query)
- **HTTP Client**: Fetch API с кастомным клиентом
- **Styling**: Emotion (встроено в MUI)

### Структура проекта

```
src/
├── app/                    # Next.js App Router
│   ├── layout.tsx         # Корневой layout
│   ├── page.tsx           # Главная страница (Dashboard)
│   ├── login/             # Страница входа
│   ├── clients/           # Управление абонентами
│   ├── tariffs/           # Управление тарифами
│   ├── devices/           # Управление устройствами
│   ├── requests/          # CRM заявок
│   ├── payments/          # Касса и платежи
│   ├── notifications/     # Уведомления
│   └── settings/          # Настройки системы
├── shared/                # Общие компоненты и утилиты
│   ├── api/              # API клиент и методы
│   ├── config/           # Конфигурация
│   ├── hooks/            # React хуки
│   ├── types/            # TypeScript типы
│   └── ui/               # UI компоненты
```

## Основные функции

### 1. Система аутентификации

- **Страница входа**: `/login`
- **JWT токены** для сессий
- **Ролевая модель доступа** (RBAC)
- **Автоматический редирект** при истечении сессии
- **Защищенные маршруты** с проверкой прав

### 2. Dashboard (Главная страница)

- **Статистические карточки**:
  - Активные абоненты
  - Заблокированные абоненты
  - Платежи за сегодня
  - Новые заявки
- **Последняя активность**:
  - Последние платежи
  - Последние заявки
- **Статистика устройств**
- **Автообновление данных** каждые 30 секунд

### 3. Управление абонентами (`/clients`)

- **Список абонентов** с пагинацией
- **Поиск** по ФИО, телефону, адресу
- **Фильтрация** по статусу, тарифу
- **Действия с лицевыми счетами**:
  - Блокировка/разблокировка
  - Приостановка/активация
  - Просмотр истории
- **Отображение**:
  - Лицевые счета
  - Текущий баланс с цветовой индикацией
  - Статус счета
  - Тарифный план

### 4. Управление тарифами (`/tariffs`)

**Три вкладки**:

#### Тарифы
- Список тарифных планов
- Цена, скорость, тип биллинга
- Привязанные услуги
- Группировка тарифов
- Активация/деактивация

#### Услуги
- Базовые услуги (Интернет, IPTV, Cloud Storage)
- Типизация услуг
- Управление активностью

#### Группы тарифов
- Группировка для отображения клиентам
- Количество тарифов в группе

### 5. Управление устройствами (`/devices`)

- **Список MikroTik устройств**
- **Мониторинг статуса** (онлайн/офлайн/ошибка)
- **Операции**:
  - Ping устройства
  - Тест подключения к API
  - Синхронизация
- **Информация**:
  - IP-адрес
  - Описание
  - Количество подключенных абонентов
  - Время последней проверки

### 6. CRM заявок (`/requests`)

- **Список заявок** от потенциальных клиентов
- **Фильтрация**:
  - По статусу (новая, в работе, выполнена, отменена)
  - По исполнителю
- **Управление статусами** с комментариями
- **Создание лицевых счетов** из выполненных заявок
- **Информация о заявке**:
  - Контактные данные
  - Адрес подключения
  - Желаемые услуги

### 7. Касса и платежи (`/payments`)

- **Статистика платежей**:
  - За сегодня
  - За месяц
  - Ожидающие платежи
- **История платежей** с фильтрацией
- **Ручное пополнение счетов**:
  - Поиск клиента
  - Выбор лицевого счета
  - Указание суммы и комментария
- **Управление платежами**:
  - Подтверждение
  - Отмена
  - Просмотр чеков

### 8. Система уведомлений (`/notifications`)

**Две вкладки**:

#### История уведомлений
- Список отправленных уведомлений
- Фильтрация по типу, каналу, статусу
- Повторная отправка при ошибках

#### Шаблоны уведомлений
- Редактирование шаблонов сообщений
- Поддержка переменных ({{clientName}}, {{balance}}, etc.)
- Управление для разных каналов (Telegram, SMS)

### 9. Настройки системы (`/settings`)

**Четыре вкладки**:

#### Общие настройки
- Информация о компании
- Yandex Maps API ключ

#### Настройки биллинга
- Автоматическая блокировка
- Интервал проверки балансов
- Настройки уведомлений

#### Интеграции
- SMS шлюз (Huawei E3372)
- Telegram Bot
- Robokassa платежи

#### Пользователи
- Управление администраторами
- Роли и права доступа

## UI компоненты

### Базовые компоненты

- **Layout**: Основной макет с навигацией
- **ProtectedRoute**: Защита маршрутов с проверкой прав
- **StatusChip**: Отображение статусов с цветовой индикацией
- **CurrencyDisplay**: Форматирование валютных сумм
- **DateDisplay**: Форматирование дат (абсолютное/относительное)
- **SearchField**: Поле поиска с дебаунсом

### Навигация

Боковое меню с разделами:
- Дашборд
- Абоненты
- Тарифы
- Устройства
- Заявки
- Касса
- Уведомления
- Настройки

### Адаптивность

- **Мобильная версия**: Скрываемое боковое меню
- **Планшеты**: Адаптивная сетка
- **Десктоп**: Полнофункциональный интерфейс

## API интеграция

### HTTP клиент

Кастомный API клиент с поддержкой:
- **Автоматическая авторизация** (JWT токены)
- **Обработка ошибок** и таймаутов
- **Автоматический редирект** при 401 ошибке
- **Загрузка файлов**

### React Query

- **Кеширование данных** с настраиваемым временем жизни
- **Автоматическое обновление** при фокусе окна
- **Оптимистичные обновления**
- **Инвалидация кеша** при мутациях

### API методы

Организованы по модулям:
- `authApi` - аутентификация
- `clientsApi` - клиенты и лицевые счета
- `tariffsApi` - тарифы и услуги
- `devicesApi` - сетевые устройства
- `requestsApi` - заявки
- `paymentsApi` - платежи
- `notificationsApi` - уведомления
- `dashboardApi` - статистика

## Конфигурация

### Переменные окружения

```bash
# API сервер
NEXT_PUBLIC_API_URL=http://localhost:3001

# Внешние сервисы
NEXT_PUBLIC_YANDEX_MAPS_API_KEY=your_api_key
```

### Настройки приложения

Файл `src/shared/config/config.ts`:
- API endpoints и таймауты
- Настройки аутентификации
- Параметры пагинации
- Форматирование данных
- Валидация форм
- Цвета статусов

## Безопасность

### Аутентификация
- JWT токены в localStorage
- Автоматическое обновление токенов
- Защищенные маршруты

### Авторизация
- Ролевая модель доступа (RBAC)
- Проверка прав на уровне компонентов
- Скрытие функций при недостатке прав

### Валидация
- Валидация на клиенте (TypeScript типы)
- Санитизация пользовательского ввода
- Защита от XSS

## Производительность

### Оптимизации
- **Code splitting** на уровне страниц
- **Lazy loading** компонентов
- **Мемоизация** тяжелых вычислений
- **Дебаунс** для поиска

### Кеширование
- React Query для API данных
- Настраиваемое время жизни кеша
- Инвалидация при изменениях

## Развертывание

### Сборка
```bash
yarn build
yarn start
```

### Docker
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile
COPY . .
RUN yarn build
EXPOSE 3002
CMD ["yarn", "start"]
```

### Переменные окружения
- Настройка API URL
- Конфигурация внешних сервисов
- Ключи интеграций

## Мониторинг

### Логирование
- Ошибки API запросов
- Действия пользователей
- Производительность

### Метрики
- Время загрузки страниц
- Успешность API запросов
- Активность пользователей

## Расширение функциональности

### Добавление новых страниц
1. Создать компонент в `src/app/`
2. Добавить маршрут в навигацию
3. Настроить права доступа
4. Добавить API методы при необходимости

### Новые API интеграции
1. Добавить методы в `src/shared/api/`
2. Создать соответствующие хуки
3. Обновить типы в `src/shared/types/`

### Кастомизация UI
1. Обновить тему в `src/shared/config/theme.ts`
2. Создать новые компоненты в `src/shared/ui/`
3. Настроить цвета и стили

Административный интерфейс готов к использованию и может быть легко расширен для новых требований бизнеса.