# API модуля заявок (CRM)

## Обзор

Модуль заявок предоставляет полный функционал для управления заявками от потенциальных клиентов, включая создание, обработку, назначение сотрудникам и автоматическое создание клиентов.

## Основные возможности

- ✅ Создание заявок от потенциальных клиентов
- ✅ Управление статусами заявок (NEW, IN_PROGRESS, COMPLETED, CANCELLED)
- ✅ Назначение заявок сотрудникам
- ✅ Автоматическое создание клиентов из заявок
- ✅ Поиск и фильтрация заявок
- ✅ Статистика по заявкам
- ✅ Валидация переходов статусов
- ✅ Unit тесты для валидации

## API Endpoints

### Основные операции

#### POST /api/requests
Создание новой заявки

**Тело запроса:**
```json
{
  "address": "ул. Тестовая, д. 1, кв. 1",
  "firstName": "Иван",
  "lastName": "Иванов",
  "phone": "+79001234567",
  "desiredServices": ["Интернет", "IPTV"],
  "notes": "Дополнительная информация"
}
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "id": "request-id",
    "address": "ул. Тестовая, д. 1, кв. 1",
    "firstName": "Иван",
    "lastName": "Иванов",
    "phone": "+79001234567",
    "desiredServices": ["Интернет", "IPTV"],
    "status": "NEW",
    "clientId": null,
    "assignedToId": null,
    "notes": "Дополнительная информация",
    "createdAt": "2024-01-01T10:00:00Z",
    "updatedAt": "2024-01-01T10:00:00Z",
    "client": null,
    "assignedTo": null
  },
  "message": "Заявка успешно создана"
}
```

#### GET /api/requests
Получение списка заявок с фильтрацией и пагинацией

**Параметры запроса:**
- `page` - номер страницы (по умолчанию 1)
- `limit` - количество записей на странице (по умолчанию 20, максимум 100)
- `search` - поиск по ФИО, телефону, адресу
- `status` - фильтр по статусу (NEW, IN_PROGRESS, COMPLETED, CANCELLED)
- `assignedToId` - фильтр по назначенному сотруднику
- `hasClient` - фильтр по наличию привязанного клиента (true/false)
- `createdFrom` - фильтр по дате создания (от)
- `createdTo` - фильтр по дате создания (до)
- `sortBy` - поле для сортировки (createdAt, fullName, status)
- `sortOrder` - порядок сортировки (asc, desc)

**Ответ:**
```json
{
  "success": true,
  "data": [...],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

#### GET /api/requests/:id
Получение заявки по ID

#### PUT /api/requests/:id
Обновление заявки

#### DELETE /api/requests/:id
Удаление заявки

### Операции с заявками

#### POST /api/requests/:id/assign
Назначение заявки сотруднику

**Тело запроса:**
```json
{
  "assignedToId": "user-id",
  "notes": "Назначено на монтаж"
}
```

#### POST /api/requests/:id/status
Изменение статуса заявки

**Тело запроса:**
```json
{
  "status": "COMPLETED",
  "notes": "Заявка выполнена"
}
```

#### POST /api/requests/:id/create-client
Создание клиента из заявки

**Тело запроса:**
```json
{
  "middleName": "Иванович",
  "email": "ivan@example.com",
  "telegramId": "@ivanov",
  "coordinates": {
    "latitude": 55.7558,
    "longitude": 37.6176
  }
}
```

### Поиск и статистика

#### GET /api/requests/search?q=запрос
Поиск заявок

#### GET /api/requests/stats
Получение статистики по заявкам

**Ответ:**
```json
{
  "success": true,
  "data": {
    "totalRequests": 100,
    "newRequests": 20,
    "inProgressRequests": 30,
    "completedRequests": 40,
    "cancelledRequests": 10,
    "todayRequests": 5,
    "weekRequests": 15,
    "monthRequests": 25,
    "averageProcessingTime": 5.5,
    "completionRate": 40
  }
}
```

#### GET /api/requests/active
Получение активных заявок (NEW и IN_PROGRESS)

### Связанные операции

#### GET /api/requests/client/:clientId
Получение заявок по клиенту

#### GET /api/requests/phone/:phone
Получение заявок по номеру телефона

#### GET /api/requests/user/:userId/assigned
Получение заявок назначенных сотруднику

## Статусы заявок

### NEW (Новая)
- Заявка только что создана
- Можно перевести в: IN_PROGRESS, CANCELLED

### IN_PROGRESS (В работе)
- Заявка назначена сотруднику и находится в обработке
- Можно перевести в: COMPLETED, CANCELLED, NEW

### COMPLETED (Выполнена)
- Заявка успешно выполнена
- Финальный статус, изменить нельзя

### CANCELLED (Отменена)
- Заявка отменена
- Финальный статус, изменить нельзя

## Валидация

### Обязательные поля при создании
- `address` - минимум 10 символов, максимум 500
- `firstName` - минимум 2 символа, максимум 50, только буквы
- `lastName` - минимум 2 символа, максимум 50, только буквы
- `phone` - российский номер телефона
- `desiredServices` - массив от 1 до 10 услуг

### Дополнительные правила
- Телефон автоматически нормализуется к формату +7XXXXXXXXXX
- Нельзя создать активную заявку с телефоном, по которому уже есть активная заявка
- При создании заявки автоматически проверяется наличие клиента с таким телефоном
- Нельзя изменить статус завершенной или отмененной заявки

## Автоматические действия

### При создании заявки
1. Нормализация номера телефона
2. Проверка на дубликаты активных заявок
3. Поиск существующего клиента по телефону
4. Автоматическая привязка к клиенту, если найден

### При назначении заявки
1. Проверка существования и активности сотрудника
2. Автоматический перевод статуса NEW → IN_PROGRESS
3. Добавление записи в заметки с информацией о назначении

### При создании клиента из заявки
1. Проверка существования клиента с таким телефоном
2. Создание нового клиента или привязка к существующему
3. Обновление заявки с привязкой к клиенту

## Коды ошибок

- `400` - Ошибка валидации данных
- `404` - Заявка не найдена
- `409` - Конфликт (дубликат активной заявки, попытка изменить завершенную заявку)
- `500` - Внутренняя ошибка сервера

## Примеры использования

### Создание заявки от клиента
```bash
curl -X POST http://localhost:3001/api/requests \
  -H "Content-Type: application/json" \
  -d '{
    "address": "г. Москва, ул. Ленина, д. 1",
    "firstName": "Иван",
    "lastName": "Петров",
    "phone": "89001234567",
    "desiredServices": ["Интернет 100 Мбит/с", "IPTV"]
  }'
```

### Назначение заявки монтажнику
```bash
curl -X POST http://localhost:3001/api/requests/request-id/assign \
  -H "Content-Type: application/json" \
  -d '{
    "assignedToId": "user-id",
    "notes": "Назначено на завтра утром"
  }'
```

### Завершение заявки
```bash
curl -X POST http://localhost:3001/api/requests/request-id/status \
  -H "Content-Type: application/json" \
  -d '{
    "status": "COMPLETED",
    "notes": "Клиент подключен, оборудование настроено"
  }'
```

### Создание клиента из заявки
```bash
curl -X POST http://localhost:3001/api/requests/request-id/create-client \
  -H "Content-Type: application/json" \
  -d '{
    "middleName": "Иванович",
    "email": "ivan.petrov@example.com",
    "telegramId": "@ivan_petrov"
  }'
```

## Интеграция с другими модулями

### Модуль клиентов
- Автоматическое создание клиентов из заявок
- Поиск существующих клиентов по телефону
- Привязка заявок к клиентам

### Модуль аутентификации
- Проверка прав доступа к операциям с заявками
- Назначение заявок только активным сотрудникам
- Аудит действий с заявками

### Модуль уведомлений (будущая интеграция)
- Уведомления клиентов о статусе заявки
- Уведомления сотрудников о назначенных заявках
- Напоминания о просроченных заявках