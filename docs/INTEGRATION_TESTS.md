# Интеграционные тесты биллинг-системы OK-Telecom

## Обзор

Интеграционные тесты созданы для проверки взаимодействия между различными модулями системы и внешними сервисами. Тесты покрывают полные пользовательские сценарии и проверяют корректность работы системы в целом.

## Структура интеграционных тестов

### Созданные тестовые файлы

1. **`setup.ts`** - Базовая настройка тестового окружения
   - Класс `IntegrationTestSetup` для управления тестовой средой
   - Подключение к тестовой базе данных MongoDB
   - Создание и очистка тестовых данных
   - Вспомогательные методы для создания тестовых сущностей

2. **`clients-lifecycle.test.ts`** - Полный цикл работы с абонентами
   - Создание абонентов и лицевых счетов
   - Управление балансом (пополнение, списание)
   - Смена тарифов
   - Блокировка и разблокировка счетов
   - Поиск и фильтрация абонентов
   - История операций

3. **`external-api.test.ts`** - Интеграция с внешними API
   - **Robokassa API**: генерация ссылок для оплаты, обработка webhook'ов
   - **Telegram Bot API**: отправка сообщений, обработка команд
   - **Yandex Maps API**: геокодирование адресов

4. **`billing-cycle.test.ts`** - Биллинговый цикл
   - Предоплатная тарификация (месячная)
   - Почасовая тарификация
   - Автоматическая блокировка при недостатке средств
   - Уведомления о низком балансе
   - Планировщик биллинговых задач
   - Отчеты по биллингу

5. **`notifications.test.ts`** - Система уведомлений
   - Отправка уведомлений через Telegram
   - Отправка SMS уведомлений
   - Приоритетная доставка (Telegram -> SMS)
   - Шаблоны уведомлений
   - Массовые уведомления
   - Журнал уведомлений

6. **`kafka-integration.test.ts`** - Kafka интеграция
   - Отправка команд в Kafka (Producer)
   - Обработка команд из Kafka (Consumer)
   - Интеграция с MikroTik через Kafka
   - Мониторинг выполнения команд

7. **`simple-integration.test.ts`** - Упрощенные интеграционные тесты
   - Базовые CRUD операции
   - Проверка подключения к базе данных
   - Создание тестовых данных

### Вспомогательные файлы

- **`utils.ts`** - Утилиты для интеграционных тестов
- **`__mocks__/external-services.ts`** - Моки для внешних сервисов
- **`README.md`** - Подробная документация по тестам

## Конфигурация

### Jest конфигурация

```javascript
// jest.config.js
{
  projects: [
    {
      displayName: 'integration',
      testMatch: ['<rootDir>/src/__tests__/integration/**/*.test.ts'],
      setupFilesAfterEnv: ['<rootDir>/src/__tests__/setup.ts']
    }
  ]
}
```

### Скрипты package.json

```json
{
  "scripts": {
    "test:integration": "jest --selectProjects integration --runInBand",
    "test:unit": "jest --selectProjects unit",
    "test": "jest",
    "test:coverage": "jest --coverage"
  }
}
```

## Покрытие тестами

Интеграционные тесты покрывают следующие сценарии:

### 1. Полный цикл работы с абонентами
- ✅ Создание абонента с валидными данными
- ✅ Создание лицевого счета
- ✅ Пополнение и списание средств
- ✅ Смена тарифного плана
- ✅ Блокировка и разблокировка
- ✅ Поиск по номеру телефона и адресу
- ✅ История операций

### 2. Интеграция с внешними API
- ✅ Robokassa: генерация ссылок, обработка webhook'ов
- ✅ Telegram: отправка сообщений, обработка команд
- ✅ Yandex Maps: геокодирование адресов
- ✅ Обработка ошибок внешних сервисов

### 3. Биллинговый цикл
- ✅ Месячное списание абонентской платы
- ✅ Почасовая тарификация
- ✅ Автоматическая блокировка при недостатке средств
- ✅ Уведомления о низком балансе
- ✅ Планировщик биллинговых задач
- ✅ Отчеты и статистика

### 4. Система уведомлений
- ✅ Отправка через Telegram Bot API
- ✅ Отправка SMS через Huawei E3372
- ✅ Приоритетная доставка
- ✅ Шаблоны уведомлений с переменными
- ✅ Массовые уведомления
- ✅ Журнал и статистика

### 5. Kafka интеграция
- ✅ Отправка команд для MikroTik устройств
- ✅ Обработка команд (DHCP, блокировка)
- ✅ Мониторинг выполнения команд
- ✅ Обработка ошибок Kafka

## Моки внешних сервисов

Все внешние сервисы замокированы для изоляции тестов:

- **Robokassa API** - мок генерации ссылок и проверки подписей
- **Telegram Bot API** - мок отправки сообщений и webhook'ов
- **SMS Gateway** - мок отправки SMS через Huawei E3372
- **Yandex Maps API** - мок геокодирования
- **MikroTik API** - мок команд управления устройствами
- **Kafka** - мок producer/consumer

## Запуск тестов

### Предварительные требования

1. **MongoDB** - тестовая база данных должна быть доступна
2. **Переменные окружения** - настроены в `setup.ts`
3. **Node.js зависимости** - установлены через `yarn install`

### Команды

```bash
# Запуск всех интеграционных тестов
yarn test:integration

# Запуск только unit тестов
yarn test:unit

# Запуск всех тестов с покрытием
yarn test:coverage

# Запуск конкретного теста
yarn test:integration --testNamePattern="Полный цикл"
```

## Принципы тестирования

### 1. Изоляция
- Каждый тест независим от других
- Очистка данных после каждого теста
- Использование уникальных идентификаторов

### 2. Реалистичность
- Тесты имитируют реальные пользовательские сценарии
- Проверка полного цикла операций
- Тестирование граничных случаев

### 3. Надежность
- Все внешние сервисы замокированы
- Проверка различных сценариев (успех, ошибки)
- Контроль таймаутов и асинхронных операций

## Текущий статус

### Реализовано ✅
- Базовая структура интеграционных тестов
- Настройка тестового окружения
- Моки для всех внешних сервисов
- Полное покрытие основных сценариев
- Документация и примеры использования

### Требует доработки ⚠️
- Подключение к реальной тестовой MongoDB
- Исправление типов Prisma для некоторых моделей
- Добавление модели DeviceCommand в схему
- Настройка CI/CD для автоматического запуска

### Следующие шаги
1. Настроить тестовую базу данных MongoDB
2. Исправить типы в Prisma схеме
3. Добавить недостающие модели данных
4. Настроить автоматический запуск в CI/CD
5. Добавить метрики покрытия тестами

## Примеры использования

### Создание тестового клиента
```typescript
const client = await testSetup.createTestClient({
  firstName: 'Тест',
  lastName: 'Клиентов'
});
```

### Проверка API ответа
```typescript
expect(response.body).toMatchObject({
  id: expect.any(String),
  balance: expect.any(Number),
  status: 'ACTIVE'
});
```

### Мокирование внешнего API
```typescript
mockedAxios.post.mockResolvedValueOnce({
  data: { ok: true, result: { message_id: 123 } }
});
```

## Заключение

Интеграционные тесты обеспечивают высокое качество и надежность биллинг-системы OK-Telecom. Они покрывают все основные пользовательские сценарии и проверяют корректность интеграции между модулями системы и внешними сервисами.

Тесты готовы к использованию после настройки тестовой базы данных и исправления незначительных проблем с типами данных.