# Структура модулей биллинг-системы OK-Telecom

## Обзор архитектуры

Система построена по модульному принципу, где каждый модуль отвечает за определенную область функциональности.

## Структура проекта

```
packages/app-server/src/
├── common/                 # Общие компоненты
│   ├── database.ts        # Подключение к БД
│   ├── errors.ts          # Кастомные ошибки
│   ├── middleware.ts      # Общие middleware
│   ├── types.ts           # Общие типы
│   ├── utils.ts           # Утилиты
│   └── index.ts           # Экспорт
├── config/                # Конфигурация
│   └── config.ts          # Настройки приложения
├── modules/               # Бизнес-модули
│   ├── auth/              # Аутентификация
│   ├── clients/           # Управление абонентами
│   ├── tariffs/           # Тарифы и услуги
│   ├── devices/           # Сетевое оборудование
│   ├── requests/          # Система заявок
│   ├── payments/          # Платежная система
│   ├── billing/           # Биллинговый движок
│   ├── notifications/     # Уведомления
│   ├── dashboard/         # Аналитика
│   └── index.ts           # Экспорт модулей
└── index.ts               # Точка входа
```

## Общие компоненты (common/)

### database.ts
- Инициализация Prisma клиента
- Настройка подключения к MongoDB
- Graceful shutdown

### errors.ts
Кастомные классы ошибок:
- `ValidationError` - Ошибки валидации
- `NotFoundError` - Ресурс не найден
- `ExternalServiceError` - Ошибки внешних сервисов
- `InsufficientFundsError` - Недостаток средств
- `UnauthorizedError` - Неавторизованный доступ
- `ForbiddenError` - Недостаточно прав

### middleware.ts
- `errorHandler` - Централизованная обработка ошибок
- `requestLogger` - Логирование запросов

### types.ts
Общие типы системы:
- API Response типы
- Фильтры для поиска
- Kafka сообщения
- Robokassa типы
- Telegram типы
- SMS типы

### utils.ts
Утилиты для:
- Работы с паролями (bcrypt)
- JWT токенов
- Валидации данных
- Работы с датами
- Пагинации
- Шаблонов уведомлений

## Конфигурация (config/)

### config.ts
Централизованная конфигурация:
- Настройки сервера
- База данных
- Kafka
- JWT
- Биллинг
- Уведомления
- Внешние сервисы
- Безопасность
- Мониторинг

## Модули (modules/)

### Структура модуля
Каждый модуль содержит:
```
module-name/
├── index.ts              # Экспорт модуля
├── module-name.service.ts    # Бизнес-логика
├── module-name.controller.ts # HTTP контроллеры
├── module-name.middleware.ts # Специфичные middleware
├── module-name.types.ts      # Типы модуля
└── module-name.routes.ts     # Маршруты API
```

### Планируемые модули

#### 1. auth - Аутентификация и авторизация
- JWT токены для администраторов
- RBAC система
- Middleware для проверки прав
- Управление ролями и пользователями

#### 2. clients - Управление абонентами
- CRUD операции с клиентами
- Управление лицевыми счетами
- Геолокация через Yandex Maps
- История действий

#### 3. tariffs - Тарифы и услуги
- Управление услугами
- Тарифные планы
- Группировка тарифов
- Бизнес-правила тарификации

#### 4. devices - Сетевое оборудование
- Управление MikroTik устройствами
- Проверка доступности
- Интеграция через Kafka
- Мониторинг статуса

#### 5. requests - Система заявок (CRM)
- Обработка заявок от клиентов
- Workflow статусов
- Автосоздание абонентов
- Назначение исполнителей

#### 6. payments - Платежная система
- Интеграция с Robokassa
- Обработка webhook'ов
- Ручное пополнение
- История транзакций

#### 7. billing - Биллинговый движок
- Автоматическое списание
- Предоплата и почасовая тарификация
- Cron задачи
- Автоблокировка

#### 8. notifications - Система уведомлений
- SMS через Huawei E3372
- Telegram Bot API
- Шаблоны сообщений
- Приоритетная отправка

#### 9. dashboard - Панель управления
- Аналитические данные
- Метрики системы
- Графики и статистика
- Кеширование

## Принципы разработки

### 1. Разделение ответственности
- Каждый модуль отвечает за свою область
- Минимальные зависимости между модулями
- Четкие интерфейсы взаимодействия

### 2. Декларативный подход
- Конфигурация через файлы настроек
- Переменные окружения для чувствительных данных
- Минимум хардкода

### 3. Обработка ошибок
- Централизованная обработка
- Типизированные ошибки
- Graceful degradation

### 4. Безопасность
- Валидация всех входных данных
- Санитизация для предотвращения XSS/SQL injection
- Логирование действий администраторов

### 5. Производительность
- Пагинация для больших списков
- Кеширование часто запрашиваемых данных
- Оптимизированные запросы к БД

## Следующие шаги

1. Реализация модуля аутентификации
2. Создание системы управления абонентами
3. Разработка тарифной системы
4. Интеграция с MikroTik
5. Система заявок и CRM
6. Платежная система
7. Биллинговый движок
8. Система уведомлений
9. Панель аналитики